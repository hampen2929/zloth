# Court検出の改善案 (tnet_cascade_rtdetr)

**親ドキュメント**: [tnet_cascade_rtdetr_detection_improvement.md](./tnet_cascade_rtdetr_detection_improvement.md)

## 概要

本ドキュメントは、モデル `tnet_cascade_rtdetr` における Court（コート）検出の安定化に向けた改善案をまとめたものである。
定性評価において確認された「カメラ位置が低い場合の奥側の検出ブレ」および「誤検出・見逃し」への対策を主眼とする。

## 現状の課題（定性評価）

推論結果を描画した動画からの定性評価により、以下の課題が特定されている。

*   **Valデータセット**: カメラが低い位置にある動画において、コート奥側の検出がブレてしまい、誤検出や見逃しが増加する。
*   **Testデータセット**: 同様に、コート奥側の検出が不安定であり、精度低下の要因となっている。

## 改善案

優先度（Priority）に基づき、以下の改善策を提案する。

### P0: データ拡張（Augmentation）の強化

**目的**: カメラアングルの多様性を人工的に作り出し、特定の視点（特に低い位置からの視点）に対するロバスト性を向上させる。

*   **透視変換（Perspective Transform）**:
    *   画像を台形に変形させることで、カメラアングルが変わったような効果を与える。特に、より低い視点や高い視点からの見え方をシミュレーションする。
*   **ランダムクロップとリサイズ**:
    *   コートの一部を拡大して学習させることで、解像度が低い（奥側の）領域への対応力を高める。
*   **Motion Blur**:
    *   動画のブレをシミュレーションし、多少の画質劣化があっても検出できるようにする。

### P1: 損失関数（Loss Function）の調整と重点学習

**目的**: 検出が難しい「奥側の小さな領域」に対するモデルの感度を高める。

*   **Small Objectに対する重み付け**:
    *   コート奥側の特徴点（コーナーなど）は画像上で小さく表示されるため、損失関数において小さいオブジェクトの検出ミスに対するペナルティを大きくする。
*   **Hard Example Mining**:
    *   現状で誤検出・見逃しが発生している「低いカメラ位置」のデータを特定し、Epoch内でこれらのデータが選ばれる頻度を上げる（オーバーサンプリング）、またはLossの重みを動的に大きくする（Focal Loss等の活用・調整）。

### P2: 入力解像度の最適化

**目的**: 遠方の情報をより詳細にモデルに伝える。

*   **解像度の引き上げ**:
    *   現在の入力解像度を確認し、計算コストが許容範囲内であれば解像度を上げる。特に奥側のコートラインが潰れてしまっている場合に有効。
    *   アスペクト比を維持したままリサイズしているか再確認し、歪みが検出に悪影響を与えていないか検証する。

### P3: 時系列情報の活用（後処理）

**目的**: 動画としての連続性を利用し、フレームごとの検出ブレを抑制する。

*   **時間的平滑化（Temporal Smoothing）**:
    *   コートの位置・形状は短時間で急激に変化しないため、過去数フレームの検出結果との移動平均を取る、またはカルマンフィルタを用いて位置を推定・補正する。
    *   検出が途切れたフレーム（見逃し）に対しては、前後のフレームから位置を補完する。

### P4: モデルアーキテクチャの微調整

**目的**: 遠近感に強い特徴抽出を行う。

*   **Deformable Convolutionの活用**:
    *   RT-DETRのバックボーンやエンコーダにおいて、幾何学的な変形に強いDeformable Convolutionの適用範囲を検討する（既に採用されている場合は設定を見直す）。
