# tnet_cascade_rtdetr: Court検出 改善案（P2: 安定化）

## 背景 / 目的
推論結果を描画した動画の定性評価から、Court検出に以下の問題が確認された。

- **Val（カメラが低い位置）**: 画面奥側（遠方）の検出がブレ、**誤検出・見逃し**が増える
- **Test**: 画面奥側（遠方）の検出がブレ、**誤検出・見逃し**が増える

本ドキュメントでは、上記の「奥側での不安定さ」に対して、改善案を **優先度付き（効果×工数×リスク）** で整理する。

---

## 現象の整理（定性所見 → 失敗モード）
奥側は一般に以下の条件が重なりやすく、検出が不安定になりやすい。

- **投影歪み/フォアショートニング**: 低位置カメラで奥側が細く潰れて見える
- **スケール不足**: 奥側のコート境界が小さく、1〜数pxレベルの揺れがIoU/判定に大きく効く
- **モーションブラー/圧縮劣化**: 遠方は高周波成分が消えやすい
- **負例の増加**: 奥側は広告/観客席/ラインの見え方が近いテクスチャと混ざり、誤検出が増える
- **時系列のブレ**: フレーム間でbboxが揺れて、閾値近傍の予測がON/OFFしやすい（見逃し/再出現）

---

## 改善の基本方針
1. **奥側の学習信号を増やす**（データ/損失/サンプリング）
2. **奥側が安定する表現に寄せる**（解像度・スケール・幾何の導入）
3. **動画として整える**（時系列整形・制約での後処理）

---

## 優先度付き 改善案
優先度は以下で表記する。

- **P0: すぐ効きやすい / 低コストで試せる**
- **P1: 効果が高い見込み / 中コスト**
- **P2: 中優先（本テーマ） / 実装・運用コストと相談**
- **P3: 長期施策 / 研究要素が強い**

### P0（最優先で試す）
#### P0-1. 奥側に寄せたハード例マイニング（データサンプリング）
- **狙い**: 奥側失敗が増える条件（低位置・遠方・ブラー・圧縮）を学習で厚くする
- **やること**
  - 学習データに「奥側で失敗しやすい動画/フレーム」をタグ付けして **オーバーサンプル**
  - 既存推論で誤検出/見逃しが出たフレームを収集し、**追加アノテ** or **再学習セットへ優先投入**
  - 画像を上下に分割し、**上側（奥側）のラベルが含まれるサンプル比率を強制**（例: batch内の一定割合）
- **期待効果**: 見逃し/誤検出の両方を改善しやすい（最短距離）
- **リスク**: 近側の性能低下（分布偏り）→ 混合比率で制御

#### P0-2. データ拡張の「遠方/低位置」寄せ（幾何 + 画質劣化）
- **狙い**: 奥側特有の見え方を増やし汎化させる
- **やること**
  - **Perspective/Projective**（台形変形を強める）で奥側が潰れる見えを増やす
  - **Random Resize + Large scale jitter**（小物体化を作る）
  - **Motion blur / JPEG / Down-up**（遠方劣化を模擬）
  - **CutMix/Mosaic**（背景のバリエーション増加。ただしコート形状タスクでは混ぜ方に注意）
- **期待効果**: Val低位置・Testの奥側ブレに直撃
- **リスク**: 変形が強すぎるとラベル整合が崩れる → 強度レンジを段階導入

#### P0-3. 推論の閾値/後処理の再チューニング（奥側ブレ対策の即効薬）
- **狙い**: 閾値近傍のON/OFFで見逃しが増える問題を抑える
- **やること**
  - 奥側領域（例: 画像上半分）で **score閾値を別設定**（低めにして見逃し減）
  - NMS/重複抑制の設定見直し（bboxが揺れて別物判定にならないように）
  - **min-size** 制約（小さすぎる誤検出の除去）を奥側だけ緩和/強化の検討
- **期待効果**: すぐ改善を確認できる
- **リスク**: 誤検出が増える方向に振れやすい → 奥側限定・動画平滑化とセット推奨

---

### P1（次に効かせたい：モデル/学習の改善）
#### P1-1. 入力解像度 or マルチスケール強化（奥側の線/境界の情報量確保）
- **狙い**: 奥側の境界が小さくなる問題に対して、情報量を増やす
- **やること**
  - 入力解像度を段階的に上げて効果確認（計算量と相談）
  - マルチスケール学習（scale jitterの強化、Feature Pyramidの活用確認）
- **期待効果**: 奥側の見逃し・ジッタ低下
- **リスク**: 速度/メモリ増、最適化が必要

#### P1-2. Loss / マッチングの見直し（小さく潰れた奥側を拾う）
- **狙い**: 小物体に相当する奥側のコート境界が、学習で不利になっている可能性を補正
- **やること（候補）**
  - bbox回帰の重み付け（小面積bboxの回帰誤差を相対的に重視）
  - Hard-negative抑制（背景の誤検出が多い領域で分類を安定化）
- **期待効果**: スコアの安定化（閾値近傍の揺れ減）
- **リスク**: 全体APのトレードオフ → 影響を局所評価（奥側メトリクス）で見る

---

### P2（中優先：Court検出の「安定化」本丸）
#### P2-1. 時系列スムージング（動画としての安定化）
- **狙い**: フレーム間のbboxジッタを抑え、誤検出・見逃し（ON/OFF）を減らす
- **やること（段階導入）**
  - **EMA（指数移動平均）**でbbox座標を平滑化（scoreも平滑化）
  - **IoUベース追跡**で同一コートを紐付けし、短い欠落は補間（最大欠落フレーム数を制限）
  - **Kalman filter** 等で速度モデルを導入（カメラパン/ズームがある場合に有効）
- **期待効果**: 「ブレて誤検出/見逃しが増える」問題に直結して改善
- **リスク**: 急なカット/大きな視点変化で追従ミス → リセット条件（IoU低下/score低下）を明確化

#### P2-2. 幾何制約による形状安定化（コートは“それっぽい四角形”である）
- **狙い**: コートが満たすべき幾何条件で、揺れや誤検出を抑える
- **やること（タスク定義に応じて選択）**
  - 出力がbboxの場合でも、推定結果に対して
    - **面積/縦横比/位置**の妥当範囲チェック（外れ値除去）
    - 連続フレームで **面積変化率** に上限を設ける（ジッタ抑制）
  - 出力を四点（四隅）やセグメへ拡張できるなら
    - **凸四角形制約**、交差禁止、平行線/直角などの弱い正則化
    - 推定四点から **ホモグラフィ** を安定推定し、フレーム間で滑らかに
- **期待効果**: 誤検出の抑制 + 安定化（奥側で特に効きやすい）
- **リスク**: 競技/画角で形状の許容範囲が変わる → ルールは「弱く」入れる

#### P2-3. 奥側領域に対する“二段階”戦略（検出→局所リファイン）
- **狙い**: まず荒く拾い、奥側だけを高解像で詰めてジッタを減らす
- **やること**
  - 1st passでコート候補を検出
  - 奥側（例: 上半分 or 推定ホモグラフィで遠方域）を切り出し、
    - 高解像で再推論（軽量ヘッド/専用リファイナ）
    - またはライン/角のキー点推定で安定化
- **期待効果**: 奥側のブレを構造的に下げられる
- **リスク**: パイプライン複雑化・推論遅延

---

### P3（長期：タスク再設計レベル）
#### P3-1. Courtをbboxではなく「線/角/セグメ」で表現して安定化
- **狙い**: コート境界は領域/線としての方が時系列で安定しやすい
- **案**
  - セグメ（court領域）→ 最終的に四角形/境界へフィット
  - キーポイント（四隅/交点）→ 幾何制約で補正
- **期待効果**: 視点変化・遠方でも安定しやすい
- **リスク**: 学習/評価/アノテのコスト増

---

## 検証設計（“奥側の安定化”を数字で見る）
定性だけでなく、奥側の改善を定量で追える指標を追加する。

- **領域別AP/Recall**: 画像上半分（奥側）と下半分（手前）で分けて評価
- **時系列ジッタ指標**:
  - 同一トラックの連続フレーム間 IoU の分布（中央値/下位5%）
  - bbox座標（中心/幅高）のフレーム間差分の分布
- **見逃しの連続長**: 欠落が何フレーム続いたか（補間前/後）
- **誤検出率**: 奥側領域でのFP/分

---

## 推奨ロードマップ（まず何をやるか）
- **Step 1（即日〜短期）**: P0-1 / P0-2 / P0-3 を小さく回して、奥側メトリクスを作る
- **Step 2（短期〜中期）**: P1-1 を中心に、奥側の情報量不足を解消
- **Step 3（中期）**: P2-1 を導入して、動画上の体感品質（ブレ/ONOFF）を確実に落とす
- **Step 4（中期）**: P2-2 / P2-3 で誤検出を削りつつ安定性を詰める

