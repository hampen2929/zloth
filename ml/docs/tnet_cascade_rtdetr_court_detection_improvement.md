# TNet Cascade RT-DETR Court検出改善計画

## 概要

本ドキュメントは、TNet Cascade RT-DETRモデルにおけるCourt（コート）検出の安定化と精度向上のための改善案を優先度付きでまとめたものです。

---

## 優先度定義

| 優先度 | 説明 | 実装目安 |
|--------|------|----------|
| **P0 (緊急)** | 本番運用に影響する重大な問題 | 即時対応 |
| **P1 (高)** | 検出精度に大きく影響する改善 | 1-2週間 |
| **P2 (中)** | 安定性向上・中程度の改善 | 2-4週間 |
| **P3 (低)** | あれば良い改善・最適化 | 将来的に対応 |

---

## P0（緊急）: クリティカルな問題の修正

### P0-1: False Negative（検出漏れ）の低減

**問題**: コートが存在するにも関わらず検出されないケースが発生

**改善案**:
- [ ] 信頼度閾値（confidence threshold）の調整
  - 現在値の検証と最適値の探索
  - クラス別閾値の導入検討
- [ ] NMS（Non-Maximum Suppression）パラメータの見直し
  - IoU閾値の調整
  - Soft-NMSの導入検討

**期待効果**: Recall向上 +5-10%

### P0-2: 極端な照明条件での検出失敗

**問題**: 逆光・強い影・夜間照明下での検出精度低下

**改善案**:
- [ ] 画像前処理パイプラインの強化
  - ヒストグラム均等化
  - CLAHE（Contrast Limited Adaptive Histogram Equalization）
- [ ] 推論時のTTA（Test-Time Augmentation）導入

**期待効果**: 悪条件下でのmAP +10-15%

---

## P1（高優先）: 検出精度の大幅改善

### P1-1: コートライン検出の精度向上

**問題**: コートの境界線（ライン）の検出が不安定

**改善案**:
- [ ] アンカーボックスのアスペクト比最適化
  - コート形状（長方形）に特化したアンカー設計
- [ ] Attention機構の強化
  - Deformable Attentionのサンプリングポイント増加
  - Cross-scale feature fusionの改善
- [ ] ライン検出専用ヘッドの追加
  - セグメンテーションヘッドとの併用

**期待効果**: IoU精度 +3-5%

### P1-2: 部分遮蔽時の検出ロバスト性

**問題**: プレイヤーや機材によるコートの部分遮蔽時に検出が不安定

**改善案**:
- [ ] オクルージョン対応データ拡張
  - Random Erasing
  - CutOut/CutMix
  - Copy-Paste Augmentation
- [ ] コンテキスト情報の活用強化
  - 周辺領域からのコート推定
  - 時系列情報の活用（動画の場合）

**期待効果**: 部分遮蔽時の検出率 +15-20%

### P1-3: マルチスケール検出の改善

**問題**: カメラ距離によってコートサイズが大きく変動

**改善案**:
- [ ] FPN（Feature Pyramid Network）の最適化
  - 追加スケールレベルの導入
  - BiFPN/PANet構造への変更検討
- [ ] 入力解像度の動的調整
  - 検出対象サイズに応じた解像度選択

**期待効果**: 遠距離/近距離シーンでのAP +5-8%

---

## P2（中優先）: Court検出の安定化

### P2-1: 時間的一貫性の確保

**問題**: フレーム間での検出結果のブレ（ジッター）

**改善案**:
- [ ] トラッキング統合
  - ByteTrack/BoT-SORTとの連携
  - 検出結果の時間平滑化
- [ ] 検出結果のカルマンフィルタリング
  - バウンディングボックス座標の安定化
- [ ] 信頼度スコアの時間的平滑化
  - EMA（指数移動平均）の適用

**期待効果**: フレーム間ジッター -50%以上

### P2-2: コート種別の分類精度向上

**問題**: テニス/バドミントン/バスケットボール等の誤分類

**改善案**:
- [ ] 分類ヘッドの強化
  - より深い分類ネットワーク
  - Focal Lossの導入
- [ ] コート種別特徴量の学習強化
  - ライン配置パターンの学習
  - コート表面テクスチャの活用
- [ ] Few-shot学習の導入
  - 新規コート種別への対応力向上

**期待効果**: 分類精度 +5-10%

### P2-3: エッジケースへの対応

**問題**: 特殊な視点・一部のみ映るコートの検出

**改善案**:
- [ ] 俯瞰/斜め視点データの増強
  - 合成データ生成
  - Homography変換によるデータ拡張
- [ ] 部分コート検出の明示的学習
  - 部分コートラベルの追加
  - マルチラベル学習の導入

**期待効果**: エッジケース対応率 +20-30%

### P2-4: 推論速度と精度のトレードオフ最適化

**問題**: リアルタイム処理と精度のバランス

**改善案**:
- [ ] モデル量子化（INT8/FP16）
  - TensorRT最適化
  - ONNX Runtime最適化
- [ ] 選択的処理の導入
  - 簡易シーンでの軽量推論
  - 困難シーンでの精密推論
- [ ] バッチ処理の最適化
  - 動的バッチサイズ調整

**期待効果**: 推論速度 +30-50%（精度維持）

---

## P3（低優先）: 将来的な改善・最適化

### P3-1: ドメイン適応の強化

**改善案**:
- [ ] 自己教師あり事前学習
  - MAE/BEiTスタイルの事前学習
- [ ] 半教師あり学習の導入
  - 疑似ラベリング
  - Consistency Regularization

### P3-2: モデルアーキテクチャの進化

**改善案**:
- [ ] 最新バックボーンの検証
  - ConvNeXt V2
  - EVA-02
- [ ] RT-DETR v2への移行検討
- [ ] カスケード構造の最適化
  - ステージ数の検討
  - 各ステージのIoU閾値調整

### P3-3: 学習パイプラインの改善

**改善案**:
- [ ] AutoML/NASの活用
  - アーキテクチャ検索
  - ハイパーパラメータ最適化
- [ ] 知識蒸留の導入
  - 大規模モデルからの知識転移
- [ ] カリキュラム学習
  - 難易度順の学習データ提示

### P3-4: 評価・モニタリング強化

**改善案**:
- [ ] 詳細なエラー分析パイプライン
  - 失敗ケースの自動分類
  - ハードネガティブマイニング
- [ ] A/Bテスト基盤の構築
- [ ] 本番環境での継続的モニタリング
  - 精度ドリフト検出
  - 自動アラート

---

## 実装ロードマップ

```
Phase 1 (Week 1-2): P0対応
├── P0-1: 閾値調整・NMS最適化
└── P0-2: 照明条件対応

Phase 2 (Week 3-6): P1対応
├── P1-1: ライン検出精度向上
├── P1-2: オクルージョン対応
└── P1-3: マルチスケール改善

Phase 3 (Week 7-10): P2対応
├── P2-1: 時間的一貫性
├── P2-2: コート種別分類
├── P2-3: エッジケース対応
└── P2-4: 推論最適化

Phase 4 (Week 11+): P3対応
└── 継続的な改善・最適化
```

---

## 評価指標

| 指標 | 現状（推定） | 目標 |
|------|-------------|------|
| mAP@0.5 | 75% | 85%+ |
| mAP@0.5:0.95 | 55% | 65%+ |
| Recall@0.5 | 80% | 90%+ |
| 推論速度 (FPS) | 30 | 45+ |
| フレーム間ジッター | - | -50% |

---

## 参考資料

- [RT-DETR Paper](https://arxiv.org/abs/2304.08069)
- [Cascade R-CNN](https://arxiv.org/abs/1712.00726)
- [DETR: End-to-End Object Detection with Transformers](https://arxiv.org/abs/2005.12872)

---

*最終更新: 2026-01-08*
