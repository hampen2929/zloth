## tnet_cascade_rtdetr: Court検出の改善案（安定化 / P2 中優先）

> 注: このワークスペース内で参照元の `ml/docs/tnet_cascade_rtdetr_detection_improvement.md` が見つからなかったため、Court検出の「安定化（フレーム間の揺れ・瞬断・誤切替の抑制）」に一般的に効く施策を、実装コストと期待効果の観点で優先度付けして整理する。

### 目的（P2）
- **court検出結果のフレーム間安定化**（ジッタ/フリッカ/瞬断/別コートへの誤スイッチを減らす）
- 既存精度を大きく落とさず、運用で破綻しやすいケース（遮蔽・モーションブラー・照明変動・観客席/看板・カメラ切替）での挙動を改善する

### 成功指標（推奨）
- **Flicker rate**: Nフレーム窓で「未検出↔検出」の切替回数
- **Jitter**: 連続フレームの \(1 - IoU\)（または中心/角点の移動量）平均・p95
- **Switch error**: 別コート/背景領域へ大きく飛ぶイベント回数（閾値: IoU < 0.1 など）
- **Stability@Recall**: recall を維持したまま jitter/flicker をどれだけ削減できたか

---

## 改善案（優先度付き）

### P0（すぐ効く / 低リスク）: 推論・後処理での安定化ガードレール
- **時間方向スムージング（EMA / ヒステリシス）**
  - **内容**: bbox/quad を指数移動平均で平滑化し、スコア閾値にヒステリシス（入る閾値 > 出る閾値）を導入
  - **狙い**: 検出の瞬断・点滅を抑える
  - **注意**: 画角切替時はリセット条件が必要（急激な画面変化を検知したら追従を切る）
- **追跡併用（Detect-then-Track / Kalman）**
  - **内容**: 検出が安定している間はトラッカで補間し、検出が崩れた時だけ再同期
  - **狙い**: モーションブラーや一時遮蔽での未検出を埋める
- **幾何制約フィルタ（courtらしさの検証）**
  - **内容**: courtを四角形（quad）として扱えるなら、以下を満たさない候補を棄却/減点
    - 凸四角形である
    - 面積が急変しない（前フレーム比）
    - アスペクト比/傾きが許容範囲
  - **狙い**: 看板・床模様などの偽陽性を落とし、誤スイッチを抑える
- **「前フレーム整合性」スコアで候補を選ぶ**
  - **内容**: 複数候補がある場合、score だけでなく「前フレームとの IoU」を加味して最終候補を選択
  - **狙い**: 近傍の正解に張り付かせ、突然の飛びを抑える
- **動的しきい値（信頼度に応じたNMS/採用）**
  - **内容**: 低信頼の時は厳しめに棄却、高信頼の時は安定化側に寄せる（例: top-1固定、またはtop-kから整合性で選ぶ）
  - **狙い**: 「怪しい時に暴れない」挙動

### P1（効果大 / 中コスト）: データ・学習で「揺れやすい原因」を潰す
- **失敗ケース収集とスライス評価（最優先）**
  - **内容**: flicker/jitter/switch を引き起こす動画断片を収集し、スライス（照明/遮蔽/ズーム/カメラ角）別にメトリクス可視化
  - **狙い**: 改善が安定化に効いているかを定量で追えるようにする
- **ハードネガティブ追加（床のライン/看板/観客席/別コート）**
  - **内容**: courtに似た矩形・ライン構造の背景を負例として明示的に増やす
  - **狙い**: 偽陽性→誤スイッチの主因を低減
- **ラベル品質の強化（特に境界・部分写り）**
  - **内容**: 「部分的にしか写っていないcourt」や「遮蔽時」のアノテ方針を統一し、曖昧ラベルを減らす
  - **狙い**: 学習の揺れ（境界の不安定さ）を抑える
- **安定化を意識したAugment**
  - **内容**: motion blur / low light / glare / jpeg劣化 / perspective / random crop を「動画由来の揺れ」に近い分布で追加
  - **狙い**: スコア落ち→瞬断の減少
- **フレーム間整合性の正則化（動画がある場合）**
  - **内容**: 連続フレームで予測が急変しないよう、擬似ラベル/一致損失（consistency loss）を導入
  - **狙い**: 本質的に「揺れにくい」モデルへ誘導

### P2（中長期 / 構造変更）: courtを「箱」ではなく「幾何」で捉える
- **quad/角点（keypoint）予測への拡張**
  - **内容**: bbox だけでなく4隅（または主要ライン交点）を回帰し、後段でquadを再構成
  - **狙い**: bboxの揺れより意味のある幾何量で安定化しやすい（制約も掛けやすい）
- **セグメンテーション補助（court領域 or ライン）**
  - **内容**: court領域/ラインマップを補助タスクにし、推論後に形状をフィット
  - **狙い**: ラインが見えるがbboxが不安定、のケースで頑健
- **マルチスケール/軽量TTA + 整合性融合（WBF等）**
  - **内容**: 2スケール程度の推論を行い、整合性で融合して安定化
  - **狙い**: 小さな視点差・ブラーに対する頑健性向上（コストは増える）

---

## 実装順（推奨ロードマップ）
- **Phase 1（最短で効かせる）**: ヒステリシス + 前フレーム整合性での候補選択 + 幾何制約フィルタ
- **Phase 2（瞬断対策）**: Detect-then-Track（補間） + リセット条件（カット検知）
- **Phase 3（根本改善）**: ハードネガティブ/ラベル方針統一/スライス評価の整備
- **Phase 4（構造強化）**: 角点/ライン/セグ補助タスクの導入

---

## 検証チェックリスト
- **安定性**: flicker/jitter/switch が改善しているか（p95も確認）
- **副作用**: 追従遅れ（急ズームやカット後の復帰遅延）が許容範囲か
- **性能**: 推論遅延の増加が許容範囲か（TTA/追跡のコスト）

