# tnet_cascade_rtdetr（Detection）改善提案（tennis_dataset_full）

## 目的 / ゴール

- **目標**: VAL / TEST ともに **全指標 80%以上**（少なくとも Detection 系の主要指標を 80% 超へ）。
- **前提**: 提示いただいたレポートでは Classification（Swing / ball status 等）の値も出ていますが、**今回の学習は Detection のみ**とのことなので、本書では **Detection の改善を最優先**で扱います。

> 重要: 現状の「🏆 Overall Score」が Classification を含む設計の場合、Detection だけ改善しても 80% を超えない可能性があります。**スコア定義（重み/集約方法）をまず確認**し、Detection-only 学習時は Classification をスコアから除外/重み 0 にするのが最短です（後述）。

## 現状サマリ（提示レポートより）

### 全体

| Metric | VAL | TEST | 所見 |
| :--- | :---: | :---: | :--- |
| 🏆 Overall Score | 78.67% | 59.97% | **TEST が大幅に崩壊** |
| 📐 Det Score | 82.70% | 46.43% | **Detection が TEST で半減** |

### Detection（主要内訳）

| Metric | VAL | TEST | ギャップ |
| :--- | :---: | :---: | :--- |
| 👤 Player Det F1 (Front) | 96.26% | 86.39% | -9.87pt（許容〜要改善） |
| 👤 Player Det F1 (Back) | 90.51% | 32.16% | **-58.35pt（致命的）** |
| ⚽ Ball PCK@10px | 67.15% | 33.40% | **-33.75pt（致命的）** |
| 🏟️ Court PCK@10px | 87.58% | 46.61% | **-40.97pt（致命的）** |

### 生値（ヒント）

- **Court mean L2 px**: VAL 7.23px → TEST 57.11px（**座標系/スケール不整合や分布差を強く示唆**）
- **Ball mean L2 px**: VAL 3.35px → TEST 4.22px（誤差は増加だが Court ほど極端ではない）
- **Back player**: Precision/Recall ともに ~0.32 で頭打ち（**検出自体が機能していない**可能性）

## コードベースの現状把握（このリポジトリ内で確認できたこと）

- このリポジトリは `apps/api` / `apps/web` を中心とした **LLM コーディングエージェント基盤（dursor）**。
- `tnet_cascade_rtdetr` / `tennis_dataset_full` / RT-DETR / 評価指標（PCK, player_bbox 等）に該当する **ML学習・推論・評価コード/設定は同梱されていません**（少なくともワークスペース内検索では該当文字列が見つからず、`ml/` ディレクトリも存在しませんでした）。

したがって、本書の「改善案」は **(A) 評価/データ整合性の検証チェックリスト** と **(B) 一般的に RT-DETR + 小物体/キーポイントに効く改善案** を、今回の症状（VAL 良いが TEST 崩壊）に即して優先度付けしたものになります。

## 問題の構造（まず疑うべき順）

### 1) 評価の座標系/前処理の不整合（最優先で疑う）

特に **Court PCK の TEST だけ極端に悪い（mean L2 が 57px）** ことから、以下の可能性が高いです。

- **画像リサイズ/レターボックス**後の座標（モデル出力）と、**元解像度のGT**が混在している
- **正規化座標（0〜1）↔ ピクセル座標**の変換が split により変わっている
- PCK の「10px」が、VAL と TEST で **画像解像度が異なる**ため相対的に厳しすぎる（例: TEST が高解像度）  
  - ※この場合でも mean L2 が 57px まで跳ねるのはやや不自然なので、まずは変換不整合を疑う

> この系のバグは「モデルを良くしてもスコアが上がらない」ため、**最短で80%に近づけるには最優先で潰す**べきです。

### 2) Split の分布差（Front/Back、撮影条件、コート種別、カメラ位置）

- **Front は維持**しているのに **Back だけ崩壊**しているため、TEST の Back が VAL の Back と別世界（コート/撮影距離/露出/モーションブラー/圧縮/観客/遮蔽物など）である可能性。
- データ分割が「動画単位」で切れておらず、VAL で見た条件に寄っている（= 過学習というより **分割設計の問題**）。

### 3) 小物体（ボール）と構造物（コート）に対するモデル容量・入力解像度不足

- Ball PCK@10px の低さは **小物体 + 速い運動 + ブレ**の典型。
- Court は **直線構造 + 幾何制約**が強いので、単純回帰より「構造を使った推定（ホモグラフィ/線分検出/セグ）」が効きやすい。

## 改善案（優先度付き）

以下は「**最短でスコアが跳ねる可能性**」と「**原因切り分けの価値**」を重視した順です。

### P0（最優先）: スコア定義・評価座標系・前処理を “VAL と TEST で完全一致” させる

- **P0-1: Overall Score の構成を確認し、Detection-only 学習時は Classification の重みを 0 にする**
  - **狙い**: “Detectionだけやっているのに Overall が下駄を履けない/上がらない” 状態を解消
  - **成功条件**: Det Score が 80% を超えれば Overall も連動して 80% に近づく/到達する

- **P0-2: Court/ball keypoint の座標変換（resize, letterbox, crop）を split 横断で統一**
  - **チェック項目**
    - 学習・推論・評価の各段で、座標系が「どの画像サイズ」を基準にしているか（input 解像度 / 元解像度）
    - GT の読み込み時にスケールが掛かっているか（動画フレームのメタ情報差）
    - 推論側の後処理で逆変換（de-letterbox）が正しいか
  - **成功条件**: TEST の `court_keypoints.mean_l2_px` が VAL と同程度（~10px以下）に戻る

- **P0-3: PCK@10px の “10px” を正規化（画像短辺比・コート幅比）に変更するか、少なくとも解像度差を吸収**
  - **狙い**: 解像度差/ズーム差で不当に落ちるのを防ぐ
  - **推奨**: `PCK@α * short_side` も併記し、運用上の許容誤差に合わせた閾値を再設計

### P1（高優先）: TEST Back 崩壊の原因を特定し、Back 専用に効く改善を当てる

- **P1-1: Back の失敗モード可視化（FN/FP 上位）と “Back-only 指標” を学習中に監視**
  - **狙い**: Back のスコアだけを確実に押し上げる（全体平均に埋もれないようにする）
  - **具体**: Back での box サイズ分布、人物の相対スケール、遮蔽率、逆光などをログ化

- **P1-2: 分割の見直し（動画/コート/カメラID単位のGroup Split、Backの条件を層化）**
  - **狙い**: VAL の “見かけの良さ” を排し、TEST に近い難度で検証する
  - **成功条件**: 新VALが下がってもよい（現実に近づく）。その後の改善が TEST に転移する

- **P1-3: Back を強化するデータ拡張（撮影条件寄せ）**
  - **候補**: モーションブラー、圧縮劣化、低照度/露出揺れ、色温度、部分遮蔽、遠距離縮小（RandomResizeの下限拡大）
  - **狙い**: Back の人物が小さく/潰れる条件を学習に入れる

### P2（高優先）: Ball（小物体）改善（入力解像度・サンプリング・損失/ヘッド）

- **P2-1: 入力解像度を上げる + マルチスケール（特に推論時）**
  - **狙い**: 小物体の特徴量欠損を解消
  - **副作用**: 計算量増。まずは推論TTAから試す（スコアが伸びるかを先に確認）

- **P2-2: ボールの正例を増やすサンプリング（ball が写っているフレームのオーバーサンプル）**
  - **狙い**: “ボールが小さすぎて負ける” より前に、学習が当たる回数を増やす

- **P2-3: ハードネガティブ（白線/照明/広告/観客の白点）を収集し、誤検出抑制**
  - **狙い**: TEST で precision/recall が両方悪い状況を改善

- **P2-4: 小物体向けの損失/設計**
  - **候補**: Focal系（分類）、IoU系の調整、クエリ数増、より細かい特徴段を使う（FPN強化）

### P3（中優先）: Court（構造物/幾何制約）改善（“形” を使う）

- **P3-1: コートは keypoint 回帰単独ではなく、線/セグ + 幾何で正規化する**
  - **候補**
    - コート線セグ → 直線推定（Hough等） → 交点から keypoint
    - 既知のコート幾何（平行・直角・比率）を損失に入れる（ホモグラフィ整合性）
  - **狙い**: 見えない点（欠損/遮蔽）でも幾何で補完できる

- **P3-2: 画面外/欠損キーポイントの扱いを統一**
  - **狙い**: GT定義（見切れ）と評価ロジックの不一致で落ちるのを防ぐ

### P4（中優先）: 推論・後処理（即効性が高いことがある）

- **P4-1: 閾値最適化（Front/Backで別閾値、クラス別閾値）**
  - **狙い**: Back で recall を稼ぎ、FP は追跡/幾何で落とす

- **P4-2: TTA / スケールアンサンブル + WBF（Weighted Boxes Fusion）**
  - **狙い**: 特に ball / back player の取りこぼし改善

- **P4-3: 時系列の整合（動画ならトラッキング/スムージング）**
  - **狙い**: 単発検出の揺れを PCK/F1 に反映させない（運用でも有利）

## “80%超え” に向けた推奨実行順（最短ルート）

1. **P0（評価の整合性）を完了**  
   - TEST の court mean L2 が VAL 並みに戻らない限り、モデル改善のROIが読めない
2. **Back-only の失敗分析 → 分割/拡張（P1）**  
   - Back F1 を 32%→80% に上げるには、まず “Back の世界” を学習に入れる必要が高い
3. **Ball（P2）を解像度・サンプリングで底上げ**  
   - PCK@10px を 33%→80% は難度が高いので、評価設計（正規化PCK）も並行で調整
4. **Court（P3）を幾何制約で安定化**  
   - 46%→80% は、座標不整合が無いなら “構造利用” が近道
5. **推論最適化（P4）で最後の数ptを詰める**

## 追加で出すべき診断レポート（改善の精度を上げる）

- **Front/Back別**の以下
  - box 面積（相対面積）分布、IoU/中心誤差分布、FN/FP の典型例
- **ball/court** の以下
  - 画像解像度（W,H）分布と、PCK/mean L2 の相関
  - GT座標の min/max（画面外が混ざっていないか）
  - 予測座標とGT座標の “同一フレーム” での座標系一致確認（可視化を1枚保存）

---

## 補足: この文書の前提と次アクション

- 本リポジトリ内に ML 学習/評価実装が無いため、上記の **P0（評価/座標系）** は、実際の ML リポジトリ（学習スクリプト、dataset loader、augmentation、eval/pck 実装、可視化生成）側で確認・修正してください。
- もし別リポジトリ/パスがある場合は、そこを含めたワークスペースで同様に検索し、**具体的なファイル/関数単位**での指摘に落とし込みます。

