# tnet_cascade_rtdetr ボール検出精度改善案（モデル編）

## 背景

後処理による改善を試みたが、根本的にモデルの検出精度向上が必要と判断。特に**特定箇所での誤検出（False Positive）が多く**、後処理でカバーするには限界がある。

## 現状の課題

### 主な誤検出パターン（推定）
- コート上の特定のマーキングやライン交差点
- 選手の白い靴やユニフォームの一部
- 観客席の明るいオブジェクト
- 審判台や機材の丸い部分
- 照明の反射・ハイライト

---

## 改善案一覧（優先度順）

### 🔴 Priority 1: 高優先度（効果大・比較的実装容易）

#### 1.1 Hard Negative Mining の強化
**概要**: 誤検出が多い特定領域のサンプルを重点的に学習

**実装方法**:
- 現在誤検出が多い箇所（コートライン、審判台等）をハードネガティブとしてマイニング
- Loss計算時にこれらのサンプルの重みを上げる
- OHEM（Online Hard Example Mining）の適用

**期待効果**: 誤検出削減 30-50%

```python
# 例: ハードネガティブの重み付け
hard_negative_weight = 3.0  # 通常の3倍
```

---

#### 1.2 クラス不均衡の改善（Focal Loss チューニング）
**概要**: ボールは画像内で非常に小さく、背景との不均衡が大きい

**実装方法**:
- Focal Loss の γ（gamma）パラメータを調整（2.0 → 3.0 など）
- α（alpha）パラメータでボールクラスの重みを増加
- Quality Focal Loss への変更を検討

**期待効果**: Recall維持しつつPrecision向上

---

#### 1.3 特定領域のマスキング/重み付け学習
**概要**: 誤検出が頻発する領域を明示的にモデルに教える

**実装方法**:
- コートラインや固定オブジェクトの領域をSegmentationマスクとして用意
- これらの領域からの検出にペナルティを与える
- Auxiliary Loss として領域分類タスクを追加

**期待効果**: 特定パターンの誤検出を大幅削減

---

### 🟠 Priority 2: 中優先度（効果大・実装にやや工数）

#### 2.1 マルチスケール特徴量の強化
**概要**: ボールは小さいため、小物体検出に特化した特徴量抽出が必要

**実装方法**:
- FPN（Feature Pyramid Network）の低レベル特徴量の活用強化
- P2レベル（高解像度）の特徴量をデコーダーに追加
- Deformable Attention のサンプリングポイント数を増加

**期待効果**: 小物体検出精度 10-20% 向上

---

#### 2.2 Anchor-free検出ヘッドの改良
**概要**: RT-DETRのクエリベース検出を小物体向けに最適化

**実装方法**:
- ボール専用のlearnable queryを追加
- Query数を増加（100 → 150程度）
- 小物体向けのIoU閾値調整（0.5 → 0.3）

**期待効果**: 見逃し（False Negative）削減

---

#### 2.3 時系列情報の活用（Temporal Context）
**概要**: 単フレームでは判断困難な場合、前後フレームの情報を活用

**実装方法**:
- 3-5フレームのスタック入力
- Temporal Attention Module の追加
- LSTM/GRU による特徴量の時系列統合

**期待効果**: 動いているボールの検出率向上、静止オブジェクトの誤検出削減

---

#### 2.4 ボール特化のデータ拡張
**概要**: ボールの見た目バリエーションを増やす

**実装方法**:
- CutOut/GridMask でボール以外の領域をマスク
- ボールのCopy-Paste Augmentation
- モーションブラーの強化
- 照明条件のランダム変更

**期待効果**: 汎化性能向上

---

### 🟡 Priority 3: 低優先度（効果あり・工数大 or 検証必要）

#### 3.1 アーキテクチャの変更
**概要**: より小物体検出に特化したバックボーンへの変更

**選択肢**:
- EfficientDet のBiFPN採用
- YOLO v8 の PANet 参考
- Swin Transformer V2 への変更

**リスク**: 大規模な変更が必要、既存の学習済み重みが使えない

---

#### 3.2 Knowledge Distillation
**概要**: より大きなモデルから知識を蒸留

**実装方法**:
- 大規模モデル（ResNet-101ベース等）で学習
- 現在のモデルにsoft labelとして蒸留

**期待効果**: 精度向上しつつ推論速度維持

---

#### 3.3 Self-Training / Pseudo Labeling
**概要**: 未ラベルデータを活用

**実装方法**:
- 高信頼度の検出結果を擬似ラベルとして使用
- 徐々に閾値を下げてハードサンプルを追加

**期待効果**: データ量増加による精度向上

---

#### 3.4 Contrastive Learning の導入
**概要**: ボールと似た外観のオブジェクトを区別する能力を強化

**実装方法**:
- ボール vs 非ボール（ハードネガティブ）の対照学習
- 特徴空間でのクラスタリング改善

**期待効果**: ボールと類似オブジェクトの判別能力向上

---

## 推奨アクションプラン

### Phase 1（1-2週間）
1. **1.1 Hard Negative Mining** を実装
2. **1.2 Focal Loss チューニング** を並行で実験
3. 誤検出パターンの詳細分析・可視化

### Phase 2（2-4週間）
4. **1.3 特定領域のマスキング** を実装（Phase 1の分析結果を反映）
5. **2.4 データ拡張** の強化
6. **2.1 マルチスケール特徴量** の改良

### Phase 3（4週間以降）
7. 効果測定と追加改善の検討
8. Priority 2-3 の施策を効果を見ながら順次実装

---

## 評価指標

### 主要指標
| 指標 | 現状（推定） | 目標 |
|------|-------------|------|
| Precision | - | +20% |
| Recall | - | 維持 or +5% |
| F1 Score | - | +15% |
| 特定領域FP率 | - | -50% |

### 補助指標
- 推論速度（FPS）: 低下を10%以内に抑える
- モデルサイズ: 現状維持

---

## 備考

- 参照ドキュメント: 
  - `tnet_cascade_rtdetr_detection_improvement.md`（全体改善）
  - `tnet_cascade_rtdetr_ball_detection_improvement.md`（ボール検出改善・後処理含む）
  - `tnet_cascade_rtdetr_court_detection_improvement.md`（コート検出改善）
- 後処理による改善は別途検討済み。本ドキュメントはモデル側の改善に特化
