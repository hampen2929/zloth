# 画像添付機能の実装計画

## 現状分析

### 現在のメッセージ構造
- **Backend (Python)**: `Message` モデルは `content: str` のみ（テキストのみ）
- **Frontend (TypeScript)**: `MessageCreate` は `{ role, content }` のみ
- **Database**: `messages` テーブルは `content TEXT NOT NULL` でテキストのみ保存
- **API**: `POST /tasks/{id}/messages` は JSON でテキストのみ受け付け

### 画像を利用する箇所
1. **ChatPanel.tsx**: ユーザーが指示を入力する UI
2. **Runs API**: 指示がエージェントに渡される
3. **各エージェント/エグゼキューター**:
   - Claude Code CLI: `claude -p "instruction"` でテキストのみ
   - Codex CLI: `codex exec "instruction"` でテキストのみ
   - Gemini CLI: `gemini "instruction"` でテキストのみ
   - Patch Agent (LLM): OpenAI/Anthropic/Google API を直接呼び出し（マルチモーダル対応可能）

## 実装計画

### Phase 1: データモデルの拡張

#### 1.1 Backend - 新しい型の追加 (`domain/models.py`)
```python
class ImageAttachment(BaseModel):
    """Image attachment for messages."""
    id: str
    filename: str
    content_type: str  # image/png, image/jpeg, image/gif, image/webp
    size_bytes: int
    # 画像データはBase64でcontentに含めるか、別ストレージ参照

class MessageCreate(BaseModel):
    role: MessageRole
    content: str
    images: list[ImageAttachment] | None = None  # 新規追加

class Message(BaseModel):
    id: str
    task_id: str
    role: MessageRole
    content: str
    images: list[ImageAttachment] = []  # 新規追加
    created_at: datetime
```

#### 1.2 Database - スキーマ更新 (`storage/schema.sql`)
```sql
-- Option A: JSONとして保存（シンプル）
ALTER TABLE messages ADD COLUMN images TEXT DEFAULT '[]';

-- Option B: 別テーブル（正規化）
CREATE TABLE IF NOT EXISTS message_images (
    id TEXT PRIMARY KEY,
    message_id TEXT NOT NULL REFERENCES messages(id),
    filename TEXT NOT NULL,
    content_type TEXT NOT NULL,
    size_bytes INTEGER NOT NULL,
    data BLOB NOT NULL,  -- または外部ストレージパス
    created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
```

**推奨**: Option A（JSON形式）- 画像データはBase64でimagesフィールド内に含める。シンプルで追加のマイグレーションも容易。

#### 1.3 Backend - DAO更新 (`storage/dao.py`)
- `MessageDAO.create()` で `images` パラメータを受け取り、JSON形式で保存
- `MessageDAO.list()` で `images` を復元

### Phase 2: API の拡張

#### 2.1 API Route 更新 (`routes/tasks.py`)
```python
@router.post("/{task_id}/messages", response_model=Message, status_code=201)
async def add_message(
    task_id: str,
    data: MessageCreate,  # images フィールドを含む
    ...
) -> Message:
    # バリデーション: サポートする画像形式、サイズ制限
    # 画像保存処理
```

#### 2.2 画像サイズ・形式の制限
- 最大ファイルサイズ: 10MB (LLM API の制限に合わせて調整)
- サポート形式: PNG, JPEG, GIF, WebP
- 最大画像数: 10枚/メッセージ

### Phase 3: Frontend UI の実装

#### 3.1 ChatPanel.tsx の更新

**新しい状態管理:**
```typescript
const [attachedImages, setAttachedImages] = useState<AttachedImage[]>([]);

interface AttachedImage {
  id: string;
  file: File;
  preview: string;  // Data URL for preview
  uploading: boolean;
}
```

**UI コンポーネント:**
1. **画像アイコンボタン** (テキストエリア横)
   - クリックでファイル選択ダイアログ
   - ドラッグ＆ドロップ対応

2. **ペースト対応**
   - `onPaste` イベントで `clipboardData.items` から画像を取得
   - スクリーンショットのペースト対応

3. **プレビューエリア**
   - 添付画像のサムネイル表示
   - 削除ボタン付き

4. **アップロード状態表示**
   - アップロード中のインジケーター

#### 3.2 types.ts の更新
```typescript
export interface ImageAttachment {
  id: string;
  filename: string;
  content_type: string;
  size_bytes: number;
  data: string;  // Base64 encoded
}

export interface MessageCreate {
  role: MessageRole;
  content: string;
  images?: ImageAttachment[];
}

export interface Message {
  id: string;
  task_id: string;
  role: MessageRole;
  content: string;
  images: ImageAttachment[];
  created_at: string;
}
```

#### 3.3 メッセージ表示の更新
- 画像付きメッセージの表示
- 画像クリックで拡大表示（モーダル）

### Phase 4: エージェント/エグゼキューターへの連携

#### 4.1 RunCreate の拡張
```python
class RunCreate(BaseModel):
    instruction: str
    images: list[ImageAttachment] | None = None  # 新規追加
    ...
```

#### 4.2 CLI エグゼキューターへの対応

**Claude Code CLI:**
```python
# Claude Code は --images オプションで画像パスを渡せる（要確認）
# または一時ファイルに保存してパスを渡す
cmd = [
    "claude", "-p", instruction,
    "--images", temp_image_path,  # 複数可
]
```

**Codex CLI / Gemini CLI:**
- 画像サポートの有無を確認
- サポートなしの場合は警告を表示

#### 4.3 Patch Agent (LLM) への対応

**OpenAI Vision API:**
```python
messages = [
    {
        "role": "user",
        "content": [
            {"type": "text", "text": instruction},
            {
                "type": "image_url",
                "image_url": {"url": f"data:image/png;base64,{image_data}"}
            }
        ]
    }
]
```

**Anthropic Vision API:**
```python
messages = [
    {
        "role": "user",
        "content": [
            {"type": "text", "text": instruction},
            {
                "type": "image",
                "source": {
                    "type": "base64",
                    "media_type": "image/png",
                    "data": image_data
                }
            }
        ]
    }
]
```

**Google Gemini API:**
```python
contents = [
    {
        "parts": [
            {"text": instruction},
            {"inline_data": {"mime_type": "image/png", "data": image_data}}
        ]
    }
]
```

### Phase 5: LLM Router の更新 (`agents/llm_router.py`)

`generate()` メソッドを拡張して画像を受け取れるようにする:
```python
async def generate(
    self,
    messages: list[dict],
    images: list[ImageAttachment] | None = None,  # 新規追加
    system: str | None = None,
    ...
) -> str:
    # プロバイダーごとに画像をフォーマットして渡す
```

## ファイル変更一覧

### Backend (`apps/api/src/zloth_api/`)
1. `domain/models.py` - ImageAttachment, MessageCreate, Message の更新
2. `domain/enums.py` - 必要に応じて新しい enum 追加
3. `storage/schema.sql` - messages テーブルに images カラム追加
4. `storage/dao.py` - MessageDAO の create/list/get 更新
5. `routes/tasks.py` - add_message エンドポイント更新
6. `routes/runs.py` - create_runs で images を受け取る
7. `services/run_service.py` - 画像をエージェントに渡す処理
8. `agents/llm_router.py` - マルチモーダル対応
9. `agents/patch_agent.py` - 画像付きプロンプト構築
10. `executors/claude_code_executor.py` - 画像渡しの実装
11. `executors/codex_executor.py` - 画像サポート確認/警告
12. `executors/gemini_executor.py` - 画像サポート確認/警告

### Frontend (`apps/web/src/`)
1. `types.ts` - ImageAttachment, MessageCreate, Message 更新
2. `lib/api.ts` - addMessage の更新（必要なら FormData 対応）
3. `components/ChatPanel.tsx` - 画像アップロード UI 追加
4. `components/ui/ImageUpload.tsx` - 新規コンポーネント（アイコン、プレビュー）
5. `components/ui/ImageModal.tsx` - 画像拡大表示モーダル

## 実装優先順位

1. **High Priority** (Core機能):
   - データモデル拡張（Backend/Frontend）
   - Database スキーマ更新
   - ChatPanel への画像アップロード UI
   - Patch Agent (LLM) へのマルチモーダル対応

2. **Medium Priority** (CLI対応):
   - Claude Code CLI への画像渡し
   - 他の CLI への対応/警告表示

3. **Low Priority** (UX改善):
   - 画像プレビューのモーダル
   - ドラッグ＆ドロップ改善
   - アップロード進捗表示

## 技術的考慮事項

### 画像保存方式の選択
- **Base64 in JSON**: シンプルだがデータサイズが約33%増加
- **外部ストレージ**: スケーラブルだが複雑性増加
- **推奨**: v1 では Base64 in JSON を採用し、必要に応じて後で外部ストレージに移行

### API リクエストサイズ制限
- FastAPI のデフォルト制限を確認し、必要に応じて調整
- 大きな画像は圧縮/リサイズを検討

### セキュリティ
- 画像の MIME タイプ検証
- 画像サイズの上限設定
- XSS 対策（SVG は許可しない）
