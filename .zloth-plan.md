# CLI使用可否確認機能の実装計画

## 概要

UIのAccount Settings画面に、Claude Code、Codex、GeminiのCLI使用可否を確認できるタブを追加する。

## 現状分析

### 既存構造
- **Settings画面**: 3つのタブ (Models, GitHub App, Defaults) がある
- **CLI設定**: 環境変数で設定 (`ZLOTH_CLAUDE_CLI_PATH` 等)
- **CLI可否確認**: 現在は実行時に`FileNotFoundError`で検出するのみ

### 課題
- ユーザーは実行前にCLIが使えるか確認できない
- どのCLIが利用可能かの一覧表示がない

## 実装計画

### Phase 1: バックエンド（API）

#### 1.1 CLI状態モデルの作成
**ファイル**: `apps/api/src/zloth_api/domain/models.py`

```python
class CLIStatus(BaseModel):
    """CLI availability status."""
    name: str                  # "claude_code", "codex", "gemini"
    display_name: str          # "Claude Code", "Codex", "Gemini"
    available: bool            # CLIが存在し実行可能か
    configured_path: str       # 設定されているパス
    resolved_path: str | None  # 実際に解決されたパス (存在しない場合はNone)
    version: str | None        # バージョン情報 (取得できれば)
    error: str | None          # エラーメッセージ (あれば)

class CLIStatusResponse(BaseModel):
    """Response for CLI status endpoint."""
    executors: list[CLIStatus]
```

#### 1.2 CLI状態確認サービスの作成
**ファイル**: `apps/api/src/zloth_api/services/cli_status_service.py` (新規作成)

主な機能:
- `shutil.which()` でPATH内のCLI存在確認
- 絶対パスの場合はファイル存在確認
- `--version` コマンドでバージョン取得（タイムアウト付き）

```python
class CLIStatusService:
    def __init__(self, settings: Settings):
        self.settings = settings

    async def check_all_cli_status(self) -> list[CLIStatus]:
        """Check availability of all CLI executors."""
        ...

    async def _check_cli(self, name: str, display_name: str, cli_path: str) -> CLIStatus:
        """Check availability of a single CLI."""
        ...
```

#### 1.3 APIエンドポイントの追加
**ファイル**: `apps/api/src/zloth_api/routes/executors.py` (新規作成)

```
GET /v1/executors/status
```

レスポンス例:
```json
{
  "executors": [
    {
      "name": "claude_code",
      "display_name": "Claude Code",
      "available": true,
      "configured_path": "claude",
      "resolved_path": "/usr/local/bin/claude",
      "version": "1.0.0",
      "error": null
    },
    {
      "name": "codex",
      "display_name": "Codex",
      "available": false,
      "configured_path": "codex",
      "resolved_path": null,
      "version": null,
      "error": "CLI not found in PATH"
    },
    ...
  ]
}
```

#### 1.4 ルーターの登録
**ファイル**: `apps/api/src/zloth_api/main.py`

executorsルーターを追加登録。

---

### Phase 2: フロントエンド（Web）

#### 2.1 TypeScript型の追加
**ファイル**: `apps/web/src/types.ts`

```typescript
export interface CLIStatus {
  name: string;
  display_name: string;
  available: boolean;
  configured_path: string;
  resolved_path: string | null;
  version: string | null;
  error: string | null;
}

export interface CLIStatusResponse {
  executors: CLIStatus[];
}
```

#### 2.2 APIクライアントの拡張
**ファイル**: `apps/web/src/lib/api.ts`

```typescript
export async function getExecutorStatus(): Promise<CLIStatusResponse> {
  const res = await fetch(`${API_BASE}/executors/status`);
  if (!res.ok) throw new Error('Failed to fetch executor status');
  return res.json();
}
```

#### 2.3 Settingsタブ設定の更新
**ファイル**: `apps/web/src/components/SettingsModal.tsx`

- `SettingsTabType`に `'executors'` を追加
- `settingsTabConfig`に新しいタブエントリを追加

```typescript
{ id: 'executors', label: 'Executors', icon: <CommandLineIcon className="w-4 h-4" /> },
```

#### 2.4 Executorsタブコンポーネントの作成
**ファイル**: `apps/web/src/components/ExecutorsTab.tsx` (新規作成)

UI要素:
- 各CLIの状態カード（アイコン、名前、ステータスバッジ）
- 利用可能: 緑色のチェックマークとバージョン表示
- 利用不可: 赤色の×マークとエラーメッセージ
- 設定パスの表示
- 「再確認」ボタン（手動でステータス更新）

#### 2.5 Settings画面への統合
**ファイル**: `apps/web/src/app/settings/page.tsx`

- 新しい`executors`タブの条件分岐を追加
- `ExecutorsTab`コンポーネントをインポート・使用

---

## ファイル変更一覧

### 新規作成ファイル
1. `apps/api/src/zloth_api/services/cli_status_service.py`
2. `apps/api/src/zloth_api/routes/executors.py`
3. `apps/web/src/components/ExecutorsTab.tsx`

### 既存ファイルの修正
1. `apps/api/src/zloth_api/domain/models.py` - CLIStatusモデル追加
2. `apps/api/src/zloth_api/main.py` - ルーター登録追加
3. `apps/api/src/zloth_api/dependencies.py` - サービスのDI追加
4. `apps/web/src/types.ts` - TypeScript型追加
5. `apps/web/src/lib/api.ts` - APIクライアント関数追加
6. `apps/web/src/components/SettingsModal.tsx` - タブ設定追加
7. `apps/web/src/app/settings/page.tsx` - タブ表示追加

---

## UI設計

```
┌─────────────────────────────────────────────────────────┐
│  Settings                                               │
├─────────────────────────────────────────────────────────┤
│  [Models] [GitHub App] [Defaults] [Executors]           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  CLI Executors                          [↻ Refresh]     │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ ✓ Claude Code                        Available  │   │
│  │   Path: /usr/local/bin/claude                   │   │
│  │   Version: 1.0.0                                │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ ✗ Codex                            Unavailable  │   │
│  │   Path: codex (not found in PATH)               │   │
│  │   Error: CLI not found                          │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ ✓ Gemini                             Available  │   │
│  │   Path: /opt/gemini/gemini                      │   │
│  │   Version: 2.1.0                                │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 実装順序

1. **バックエンド**: モデル → サービス → ルート → 登録
2. **フロントエンド**: 型 → APIクライアント → コンポーネント → 統合
3. **テスト**: バックエンドテスト → フロントエンドビルド確認

---

## 考慮事項

### パフォーマンス
- CLI確認は`--version`呼び出しを含むため、タイムアウト（5秒）を設定
- フロントエンドでは初回ロード時のみ取得、手動リフレッシュ可能

### セキュリティ
- 任意のパス実行は行わない（設定ファイルのパスのみ使用）
- バージョン取得のみ、他のコマンド実行は行わない

### エラーハンドリング
- CLI不在: "CLI not found in PATH"
- 実行エラー: "Failed to execute CLI"
- タイムアウト: "CLI did not respond within timeout"
