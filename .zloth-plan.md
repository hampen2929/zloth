# P0: Phase 1 完成 (Decision Visibility 強化) 実装計画

## 目標

**Trust Ladder L2 達成**: 任意のPRについて「採択理由・Evidence・比較軸・却下理由/根拠」を1画面で説明できる状態

## 現状分析

### 既存実装
- Run/PR/Taskのデータモデルは整備済み
- CI連携・レビュー機能は実装済み
- フロントエンドのRun比較UI（RunsPanel, RunDetailPanel）は基盤あり

### 未実装（P0で必要）
- Decision エンティティとDAO
- Evidence 自動収集サービス
- 判断記録API・UI
- 比較体験向上UI
- 判断説明ダッシュボード

---

## 実装タスク

### P0-1: Decision データモデルの実装 [Backend]

#### 1.1 Enum追加 (`apps/api/src/zloth_api/domain/enums.py`)

```python
class DecisionType(str, Enum):
    """判断の種類"""
    SELECTION = "selection"       # Run選択
    PROMOTION = "promotion"       # PR化
    MERGE = "merge"               # マージ

class DeciderType(str, Enum):
    """判断者の種類"""
    HUMAN = "human"               # 人間
    POLICY = "policy"             # ポリシー（自動）
    AI = "ai"                     # AI

class OutcomeStatus(str, Enum):
    """判断結果の評価"""
    GOOD = "good"                 # 正しかった
    BAD = "bad"                   # 誤りだった
    UNKNOWN = "unknown"           # 未評価

class RiskLevel(str, Enum):
    """リスクレベル"""
    LOW = "low"                   # 軽微（自動マージ可）
    MEDIUM = "medium"             # 通常（ポリシー次第）
    HIGH = "high"                 # 重大（人間承認必須）
```

#### 1.2 Model追加 (`apps/api/src/zloth_api/domain/models.py`)

```python
# Evidence（機械的に検証可能な根拠）
class CIEvidence(BaseModel):
    """CI結果のEvidence"""
    status: str  # "passed" | "failed" | "pending"
    failed_checks: list[dict[str, str]] = []  # {name, reason}
    check_names: list[str] = []

class MetricsEvidence(BaseModel):
    """メトリクスのEvidence"""
    lines_changed: int
    files_changed: int

class ReviewEvidence(BaseModel):
    """レビュー結果のEvidence"""
    approvals: int
    change_requests: int

class RefsEvidence(BaseModel):
    """参照URLのEvidence"""
    ci_url: str | None = None
    pr_url: str | None = None

class Evidence(BaseModel):
    """Evidence構造（P0版）"""
    ci_results: CIEvidence | None = None
    metrics: MetricsEvidence | None = None
    review_summary: ReviewEvidence | None = None
    refs: RefsEvidence | None = None

# Alternative（却下された選択肢）
class RejectedRun(BaseModel):
    """却下されたRun"""
    run_id: str
    reason: str
    evidence: Evidence | None = None

class Alternative(BaseModel):
    """比較対象"""
    rejected_runs: list[RejectedRun] = []
    comparison_axes: list[str] = []  # 比較軸

# Scope（PR化の範囲）
class ExcludedPathReason(BaseModel):
    """除外パスと理由"""
    path: str
    reason: str

class PromotionScope(BaseModel):
    """PR化の範囲"""
    included_paths: list[str] = []
    excluded_paths: list[str] = []
    excluded_reasons: list[ExcludedPathReason] = []

# Decision（判断記録）
class Decision(BaseModel):
    """判断記録（DB保存用）"""
    id: str
    task_id: str
    decision_type: DecisionType
    decider_type: DeciderType
    reason: str
    evidence: dict  # JSON
    alternatives: dict | None = None  # JSON
    scope: dict | None = None  # JSON (promotion_decision用)
    outcome: OutcomeStatus | None = None
    outcome_reason: str | None = None
    outcome_refs: list[str] | None = None
    risk_level: RiskLevel | None = None
    risk_level_reason: str | None = None
    created_at: datetime

class DecisionCreate(BaseModel):
    """判断作成リクエスト"""
    decision_type: DecisionType
    decider_type: DeciderType = DeciderType.HUMAN
    reason: str
    selected_run_id: str | None = None  # selection用
    rejected_run_ids: list[str] | None = None  # selection用
    rejection_reasons: dict[str, str] | None = None  # run_id -> reason
    comparison_axes: list[str] | None = None
    run_id: str | None = None  # promotion用
    pr_id: str | None = None  # promotion/merge用
    included_paths: list[str] | None = None  # promotion用
    excluded_paths: list[str] | None = None  # promotion用
    excluded_reasons: list[ExcludedPathReason] | None = None  # promotion用
```

#### 1.3 Schema追加 (`apps/api/src/zloth_api/storage/schema.sql`)

```sql
-- Decisions (判断記録)
CREATE TABLE IF NOT EXISTS decisions (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    decision_type TEXT NOT NULL,  -- selection/promotion/merge
    decider_type TEXT NOT NULL,   -- human/policy/ai
    reason TEXT NOT NULL,
    evidence TEXT NOT NULL,        -- JSON
    alternatives TEXT,             -- JSON
    scope TEXT,                    -- JSON (promotion_decision用)
    outcome TEXT,                  -- good/bad/unknown
    outcome_reason TEXT,
    outcome_refs TEXT,             -- JSON array
    risk_level TEXT,               -- low/medium/high
    risk_level_reason TEXT,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_decisions_task ON decisions(task_id);
CREATE INDEX IF NOT EXISTS idx_decisions_type ON decisions(decision_type);
CREATE INDEX IF NOT EXISTS idx_decisions_created ON decisions(created_at);
```

#### 1.4 DAO追加 (`apps/api/src/zloth_api/storage/dao.py`)

```python
class DecisionDAO:
    """Decision Data Access Object"""

    async def create(self, task_id: str, data: DecisionCreate, evidence: Evidence) -> Decision
    async def get(self, decision_id: str) -> Decision | None
    async def list(self, task_id: str) -> list[Decision]
    async def update_outcome(self, decision_id: str, outcome: OutcomeStatus, reason: str, refs: list[str]) -> Decision
```

---

### P0-2: Evidence 自動収集の実装 [Backend]

#### 2.1 EvidenceService (`apps/api/src/zloth_api/services/evidence_service.py`)

```python
class EvidenceService:
    """Evidence自動収集サービス"""

    async def collect_ci_evidence(self, task_id: str, pr_id: str) -> CIEvidence | None
    async def collect_metrics_evidence(self, run: Run) -> MetricsEvidence
    async def collect_review_evidence(self, task_id: str, run_id: str) -> ReviewEvidence | None
    async def build_evidence(
        self,
        run: Run,
        task_id: str,
        pr_id: str | None = None,
    ) -> Evidence
```

#### 2.2 RiskService (`apps/api/src/zloth_api/services/risk_service.py`)

```python
class RiskService:
    """リスクレベル算出サービス"""

    # gen2.md の R001-R007 ルール実装
    DEPENDENCY_PATTERNS = ["package*.json", "requirements*.txt", "go.mod", "Cargo.toml", ...]
    SECURITY_PATTERNS = ["auth/", "security/", "crypto/", "*.secret", ...]
    INFRA_PATTERNS = ["terraform/", "kubernetes/", "docker-compose.yml", ...]
    DOCS_PATTERNS = ["docs/", "*.md", "README", ...]
    TEST_PATTERNS = ["tests/", "*_test.*", "*.spec.*", ...]

    def calculate_risk_level(self, files_changed: list[str]) -> tuple[RiskLevel, str]
```

---

### P0-3: 判断記録API・UIの実装 [Full-stack]

#### 3.1 Backend Routes (`apps/api/src/zloth_api/routes/decisions.py`)

```python
router = APIRouter(prefix="/v1", tags=["decisions"])

# POST /v1/tasks/{task_id}/decisions - 判断を記録
@router.post("/tasks/{task_id}/decisions")
async def create_decision(task_id: str, data: DecisionCreate) -> Decision

# GET /v1/tasks/{task_id}/decisions - 判断一覧取得
@router.get("/tasks/{task_id}/decisions")
async def list_decisions(task_id: str) -> list[Decision]

# GET /v1/decisions/{decision_id} - 判断詳細取得
@router.get("/decisions/{decision_id}")
async def get_decision(decision_id: str) -> Decision

# PATCH /v1/decisions/{decision_id}/outcome - Outcome更新
@router.patch("/decisions/{decision_id}/outcome")
async def update_decision_outcome(decision_id: str, data: OutcomeUpdate) -> Decision
```

#### 3.2 DecisionService (`apps/api/src/zloth_api/services/decision_service.py`)

```python
class DecisionService:
    """判断記録サービス"""

    def __init__(
        self,
        decision_dao: DecisionDAO,
        evidence_service: EvidenceService,
        risk_service: RiskService,
        run_dao: RunDAO,
        pr_dao: PRDAO,
    )

    async def record_selection(
        self,
        task_id: str,
        selected_run_id: str,
        rejected_run_ids: list[str],
        reason: str,
        rejection_reasons: dict[str, str],
        comparison_axes: list[str],
        decider_type: DeciderType = DeciderType.HUMAN,
    ) -> Decision

    async def record_promotion(
        self,
        task_id: str,
        run_id: str,
        pr_id: str | None,
        reason: str,
        scope: PromotionScope,
        decider_type: DeciderType = DeciderType.HUMAN,
    ) -> Decision

    async def record_merge(
        self,
        task_id: str,
        pr_id: str,
        reason: str,
        decider_type: DeciderType = DeciderType.HUMAN,
    ) -> Decision
```

#### 3.3 Frontend API (`apps/web/src/lib/api.ts`)

```typescript
export const decisionsApi = {
  create: (taskId: string, data: DecisionCreate) =>
    apiClient.post(`/tasks/${taskId}/decisions`, data),
  list: (taskId: string) =>
    apiClient.get<Decision[]>(`/tasks/${taskId}/decisions`),
  get: (decisionId: string) =>
    apiClient.get<Decision>(`/decisions/${decisionId}`),
  updateOutcome: (decisionId: string, data: OutcomeUpdate) =>
    apiClient.patch(`/decisions/${decisionId}/outcome`, data),
};
```

#### 3.4 Frontend Types (`apps/web/src/types.ts`)

```typescript
// Decision関連の型定義
interface CIEvidence { ... }
interface MetricsEvidence { ... }
interface ReviewEvidence { ... }
interface Evidence { ... }
interface RejectedRun { ... }
interface Alternative { ... }
interface PromotionScope { ... }
interface Decision { ... }
interface DecisionCreate { ... }
```

#### 3.5 Selection Decision Modal (`apps/web/src/components/SelectionDecisionModal.tsx`)

- Run選択時に理由入力を求めるモーダル
- 却下Runの理由も入力可能
- 比較軸の選択（CI, メトリクス, レビューなど）

#### 3.6 Promotion Decision Modal (`apps/web/src/components/PromotionDecisionModal.tsx`)

- PR化時に除外ファイル選択と理由入力
- scope構造を構築

#### 3.7 Merge Decision Modal (`apps/web/src/components/MergeDecisionModal.tsx`)

- マージ時の最終確認と承認理由入力

---

### P0-4: 比較体験の向上 [Frontend]

#### 4.1 RunComparisonView (`apps/web/src/components/RunComparisonView.tsx`)

```typescript
interface RunComparisonViewProps {
  runs: Run[];
  onSelect: (runId: string) => void;
}
```

機能:
- 2-3個のRunを横並びで表示
- メトリクス比較表（変更行数、ファイル数）
- CIステータスバッジ
- 差分のサイドバイサイド表示

#### 4.2 RunDetailPanel拡張 (`apps/web/src/components/RunDetailPanel.tsx`)

追加機能:
- メトリクスサマリー表示（lines_changed, files_changed）
- 「比較モード」ボタン追加
- Evidence情報の表示枠

---

### P0-5: 判断説明画面（Decision Dashboard）の実装 [Frontend]

#### 5.1 Decisions Page (`apps/web/src/app/tasks/[taskId]/decisions/page.tsx`)

タイムライン形式で判断履歴を表示:
- 各判断の理由・Evidence・比較軸を展開表示
- 却下されたRunとその理由を表示
- Outcomeの更新機能

#### 5.2 DecisionCard (`apps/web/src/components/DecisionCard.tsx`)

Decision Type に応じた表示切り替え:
- Selection: 採択Run、却下Run一覧、比較軸
- Promotion: スコープ（含む/除外ファイル）、理由
- Merge: Evidence、リスクレベル

#### 5.3 EvidenceDisplay (`apps/web/src/components/EvidenceDisplay.tsx`)

Evidence の視覚化:
- CIステータスバッジ（passed/failed/pending）
- メトリクスバー（変更行数・ファイル数）
- レビュー承認状況（approvals/change_requests）

---

## 実装順序

```
P0-1 (データモデル)
    ↓
P0-2 (Evidence自動収集)
    ↓
P0-3 (判断記録API・UI)
    ├── Backend API
    └── Frontend モーダル群
    ↓
P0-4 (比較体験向上) ← P0-1,2,3 と並行可能
    ↓
P0-5 (判断説明画面)
```

---

## テスト計画

### Unit Tests

#### Backend

1. **test_decision_dao.py**
   - `test_create_selection_decision`: Selection Decision作成
   - `test_create_promotion_decision`: Promotion Decision作成
   - `test_create_merge_decision`: Merge Decision作成
   - `test_list_decisions_by_task`: Task別一覧取得
   - `test_update_outcome`: Outcome更新

2. **test_evidence_service.py**
   - `test_collect_ci_evidence`: CI結果収集
   - `test_collect_metrics_evidence`: メトリクス収集
   - `test_collect_review_evidence`: レビュー結果収集
   - `test_build_evidence`: Evidence統合

3. **test_risk_service.py**
   - `test_high_risk_dependency_files`: 依存関係ファイル変更 → HIGH
   - `test_high_risk_security_paths`: セキュリティパス変更 → HIGH
   - `test_high_risk_infra_files`: インフラファイル変更 → HIGH
   - `test_low_risk_docs_only`: ドキュメントのみ → LOW
   - `test_low_risk_tests_only`: テストのみ → LOW
   - `test_medium_risk_default`: 上記以外 → MEDIUM
   - `test_multiple_rules_highest_wins`: 複数ルール該当時は最高リスク採用

4. **test_decision_service.py**
   - `test_record_selection_with_evidence`: Selection記録とEvidence自動収集
   - `test_record_promotion_with_scope`: Promotion記録とScope保存
   - `test_record_merge_with_risk_level`: Merge記録とリスクレベル算出

#### Frontend

1. **SelectionDecisionModal.test.tsx**
   - 理由入力必須バリデーション
   - 却下理由の複数入力
   - 比較軸選択

2. **RunComparisonView.test.tsx**
   - 複数Run表示
   - メトリクス比較表示
   - Run選択コールバック

3. **DecisionCard.test.tsx**
   - Decision Type別表示切り替え
   - Evidence展開表示

### Integration Tests

1. **test_decisions_api.py**
   - `test_create_and_list_decisions`: Decision作成→一覧取得
   - `test_decision_with_evidence_auto_collection`: Evidence自動収集統合
   - `test_decision_outcome_update_flow`: Outcome更新フロー

2. **test_pr_with_decision.py**
   - `test_pr_creation_records_promotion_decision`: PR作成時にPromotion Decision自動記録
   - `test_merge_records_merge_decision`: マージ時にMerge Decision自動記録

### E2E Tests

1. **decision_flow.spec.ts**
   - Run選択 → Selection Decision Modal → 理由入力 → Decision記録
   - PR作成 → Promotion Decision Modal → スコープ選択 → Decision記録
   - マージ → Merge Decision Modal → 確認 → Decision記録
   - Decisions Page でタイムライン表示確認

2. **comparison_view.spec.ts**
   - 複数Run表示 → 比較モード → メトリクス比較 → Run選択

---

## 成功指標（KPI）

| 指標 | 目標 | 検証方法 |
|------|------|----------|
| Decision記録率 | 100% | 全てのRun選択/PR化/マージにDecisionが記録される |
| Evidence付与率 | 100% | 全DecisionにCI/metrics/review_summaryが含まれる |
| 判断説明画面アクセス | PRごとに1画面 | `/tasks/{id}/decisions` で判断根拠確認可能 |

---

## ファイル一覧（新規作成）

### Backend
- `apps/api/src/zloth_api/domain/enums.py` (追加)
- `apps/api/src/zloth_api/domain/models.py` (追加)
- `apps/api/src/zloth_api/storage/schema.sql` (追加)
- `apps/api/src/zloth_api/storage/dao.py` (追加: DecisionDAO)
- `apps/api/src/zloth_api/services/evidence_service.py` (新規)
- `apps/api/src/zloth_api/services/risk_service.py` (新規)
- `apps/api/src/zloth_api/services/decision_service.py` (新規)
- `apps/api/src/zloth_api/routes/decisions.py` (新規)
- `apps/api/src/zloth_api/main.py` (ルーター追加)
- `apps/api/src/zloth_api/dependencies.py` (DI追加)

### Frontend
- `apps/web/src/types.ts` (追加: Decision関連型)
- `apps/web/src/lib/api.ts` (追加: decisionsApi)
- `apps/web/src/components/SelectionDecisionModal.tsx` (新規)
- `apps/web/src/components/PromotionDecisionModal.tsx` (新規)
- `apps/web/src/components/MergeDecisionModal.tsx` (新規)
- `apps/web/src/components/RunComparisonView.tsx` (新規)
- `apps/web/src/components/DecisionCard.tsx` (新規)
- `apps/web/src/components/EvidenceDisplay.tsx` (新規)
- `apps/web/src/app/tasks/[taskId]/decisions/page.tsx` (新規)
- `apps/web/src/components/RunDetailPanel.tsx` (拡張)
- `apps/web/src/components/RunsPanel.tsx` (比較モード追加)

### Tests
- `apps/api/tests/test_decision_dao.py` (新規)
- `apps/api/tests/test_evidence_service.py` (新規)
- `apps/api/tests/test_risk_service.py` (新規)
- `apps/api/tests/test_decision_service.py` (新規)
- `apps/api/tests/test_decisions_api.py` (新規)
- `apps/web/src/components/__tests__/SelectionDecisionModal.test.tsx` (新規)
- `apps/web/src/components/__tests__/RunComparisonView.test.tsx` (新規)
- `apps/web/src/components/__tests__/DecisionCard.test.tsx` (新規)
